---
apiVersion: batch/v1
kind: Job
metadata:
  name: check-postgress-reachable-and-readable
spec:
  backoffLimit: 0
  template:
    metadata:
      labels:
        app: check-postgress-reachable-and-readable
    spec:
      containers:
      - name: postgres
        image: postgres:14.2-alpine3.15
        env:
          - name: POSTGRES_HOST
            value: postgres
          - name: POSTGRES_PORT
            value: "5432"
          - name: POSTGRES_USER
            value: root
          - name: PGPASSWORD
            value: root
          - name: POSTGRES_DB
            value: rootdb
        command:
        - ash
        - -c
        - |
          set -o errexit
          set -o nounset
          # set -o xtrace

          if set +o | grep -F 'set +o pipefail' > /dev/null; then
            # shellcheck disable=SC3040
            set -o pipefail
          fi

          if set +o | grep -F 'set +o posix' > /dev/null; then
            # shellcheck disable=SC3040
            set -o posix
          fi

          #only works in bash
          #timeout 120 sh -c "while ! timeout 1 bash -c 'cat < /dev/null > /dev/tcp/${POSTGRES_HOST}/5432'; do sleep 1; echo -n .; done";
          
          timeout 120 sh -c "while ! timeout 1 ash -c 'nc -z ${POSTGRES_HOST} ${POSTGRES_PORT}'; do sleep 1; printf '%s' '.'; done";
          echo √ postgres port open;

          psql --host=${POSTGRES_HOST} --username=${POSTGRES_USER} --dbname=${POSTGRES_DB} -c '\l' > /dev/null;
          echo √ postgress access works;

          echo done;
      restartPolicy: Never


# ---
# apiVersion: batch/v1
# kind: Job
# metadata:
#   name: check-postgress-reachable-check-done
# spec:
#   backoffLimit: 0
#   template:
#     metadata:
#       labels:
#         app: check-postgress-reachable-check-done
#     spec:
#       containers:
#       - name: kubectl
#         image: bitnami/kubectl:1.23.6
#         command:
#         - bash
#         - -c
#         - |
#           set -o errexit
#           set -o nounset
#           # set -o xtrace

#           if set +o | grep -F 'set +o pipefail' > /dev/null; then
#             # shellcheck disable=SC3040
#             set -o pipefail
#           fi

#           if set +o | grep -F 'set +o posix' > /dev/null; then
#             # shellcheck disable=SC3040
#             set -o posix
#           fi

#           kubectl get no
#       restartPolicy: Never

